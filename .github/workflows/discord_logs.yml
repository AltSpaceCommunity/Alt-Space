name: Discord Logs

on:
  push:
  pull_request:
  create:
  delete:
  fork:
  issues:
  issue_comment:
  release:
  public:
  workflow_dispatch:

jobs:
  log_to_discord:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Send event to Discord
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const discordWebhook = process.env.DISCORD_WEBHOOK;
          if (!discordWebhook) {
            core.setFailed("DISCORD_WEBHOOK is not set!");
          }

          const eventName = process.env.GITHUB_EVENT_NAME;
          const payload = require(process.env.GITHUB_EVENT_PATH);

          const user = payload.sender?.login || "Unknown";
          const avatar = payload.sender?.avatar_url || "";

          let url = "";
          switch(eventName) {
            case "push":
              url = payload.head_commit?.url || "";
              break;
            case "pull_request":
              url = payload.pull_request?.html_url || "";
              break;
            case "issues":
              url = payload.issue?.html_url || "";
              break;
            case "issue_comment":
              url = payload.comment?.html_url || "";
              break;
            case "release":
              url = payload.release?.html_url || "";
              break;
            case "create":
            case "delete":
              url = `https://github.com/${payload.repository.full_name}/tree/${payload.ref}`;
              break;
            case "fork":
              url = payload.forkee?.html_url || "";
              break;
            default:
              url = payload.repository?.html_url || "";
          }

          const embedPayload = {
            embeds: [{
              title: `[${eventName}] в репозитории ${payload.repository?.full_name || "Unknown"}`,
              description: `Пользователь: **${user}**\nСсылка: ${url}`,
              color: 3447003,
              author: {
                name: user,
                icon_url: avatar
              }
            }]
          };

          await fetch(discordWebhook, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(embedPayload)
          });
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
